<div class="p-grid layout-dashboard">
    <!-- Sección de Búsqueda -->
    <div class="p-col-12">
        <div class="card search-card">
            <div class="card-header">
                <i class="pi pi-search"></i>
                <h4 style="color: white;">Buscar Producto</h4>
            </div>
            <app-input-busqueda (consultarPorId)="informacionProducto($event)"></app-input-busqueda>
        </div>
    </div>

    <!-- Datos del Producto - Cards de Estadísticas -->
    <div *ngIf="cargaInicial" class="p-col-12">
        <div class="card info-card">
            <div class="card-header">
                <i class="pi pi-box"></i>
                <h4>Información del Producto</h4>
            </div>
            
            <div class="p-grid p-mt-3">
                <div class="p-col-12 p-md-6 p-lg-2">
                    <div class="stat-card stat-primary">
                        <div class="stat-icon">
                            <i class="pi pi-tag"></i>
                        </div>
                        <div class="stat-content">
                            <span class="stat-label">No. Parte</span>
                            <span class="stat-value">{{productoDetalle.tcProducto.sNoParte}}</span>
                        </div>
                    </div>
                </div>
                
                <div class="p-col-12 p-md-6 p-lg-3">
                    <div class="stat-card stat-success">
                        <div class="stat-icon">
                            <i class="pi pi-shopping-bag"></i>
                        </div>
                        <div class="stat-content">
                            <span class="stat-label">Producto</span>
                            <span class="stat-value">{{productoDetalle.tcProducto.sProducto}}</span>
                        </div>
                    </div>
                </div>
                
                <div class="p-col-12 p-md-6 p-lg-3">
                    <div class="stat-card stat-info">
                        <div class="stat-icon">
                            <i class="pi pi-info-circle"></i>
                        </div>
                        <div class="stat-content">
                            <span class="stat-label">Descripción</span>
                            <span class="stat-value">{{productoDetalle.tcProducto.sDescripcion}}</span>
                        </div>
                    </div>
                </div>
                
                <div class="p-col-12 p-md-6 p-lg-2">
                    <div class="stat-card stat-warning">
                        <div class="stat-icon">
                            <i class="pi pi-dollar"></i>
                        </div>
                        <div class="stat-content">
                            <span class="stat-label">Precio</span>
                            <span class="stat-value">${{productoDetalle.tcProducto.nPrecioConIva | number:'1.2-2'}}</span>
                        </div>
                    </div>
                </div>
                
                <div class="p-col-12 p-md-6 p-lg-2">
                    <div class="stat-card stat-danger">
                        <div class="stat-icon">
                            <i class="pi pi-inbox"></i>
                        </div>
                        <div class="stat-content">
                            <span class="stat-label">Stock Total</span>
                            <span class="stat-value">{{productoDetalle.nCantidadTotal | number}}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráfica de Historia de Precios -->
    <div *ngIf="cargaInicial" class="p-col-12 p-lg-6">
        <div class="card chart-card">
            
            <div class="card-header">
                <i class="pi pi-chart-line"></i>
                <h4>Historia de Precios del Producto</h4>
            </div>
            
            <div class="">
                <p-chart type="line" [data]="historiaIngresoGraf" [options]="lineOptions"></p-chart>
            </div>
             
            
            <div class="p-mt-12">
                <app-historia-precio-producto [listaHistoriaPrecioProducto]="listaHistoriaPrecioProducto"></app-historia-precio-producto>
            </div>
        </div>
    </div>
   
    <!-- Gráfica de Productos por Bodega -->
    <div *ngIf="cargaInicial" class="p-col-12 p-lg-6">
        <div class="card chart-card">
            <div class="card-header">
                <i class="pi pi-building"></i>
                <h4>Distribución por Bodega</h4>
            </div>
            
            <div class="chart-container pie-chart-container">
                <p-chart type="pie" [data]="productoBodegaGraf" [options]="pieOptions" [responsive]="true"></p-chart>
            </div>
            
            <div class="p-mt-12">
                <app-modal-productos-bodega [listaProductoBodega]="listaProductoBodega" [stockTotal]="stockTotal" [traspaso]="traspaso"></app-modal-productos-bodega>
            </div>
        </div>
    </div>
    <!-- Ventas por Mes -->
    <div *ngIf="cargaInicial" class="p-col-12 p-lg-6">
        <div class="card chart-card">
            <div class="card-header">
                <i class="pi pi-calendar"></i>
                <h4>Ventas Mensuales del Producto</h4>
            </div>
            
            <div class="chart-container">
                <p-chart type="line" [data]="ventaProductoMesGraf" [options]="lineOptions"></p-chart>
            </div>

            <div class="p-mt-4">
                <p-table #dt [value]="listaProductosVentaMes" [rows]="5" [paginator]="true"
                    [globalFilterFields]="['totalVentas','cantidad', 'fechaVenta']" [rowHover]="true" 
                    dataKey="id" styleClass="p-datatable-sm p-datatable-striped"
                    currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} registros" 
                    [showCurrentPageReport]="true" responsiveLayout="scroll">
                    
                    <ng-template pTemplate="caption">
                        <div class="p-d-flex p-ai-center p-jc-between">
                            <span class="p-input-icon-left">
                                <i class="pi pi-search"></i>
                                <input pInputText type="text" (input)="dt.filterGlobal($event.target.value, 'contains')"
                                    placeholder="Buscar..." class="p-inputtext-sm" />
                            </span>
                        </div>
                    </ng-template>
                    
                    <ng-template pTemplate="header">
                        <tr>
                            <th pSortableColumn="totalVentas">
                                <div class="p-d-flex p-ai-center">
                                    <i class="pi pi-dollar p-mr-2"></i>
                                    Total Ventas
                                    <p-sortIcon field="totalVentas"></p-sortIcon>
                                </div>
                            </th>
                            <th pSortableColumn="cantidad">
                                <div class="p-d-flex p-ai-center">
                                    <i class="pi pi-shopping-cart p-mr-2"></i>
                                    Cantidad
                                    <p-sortIcon field="cantidad"></p-sortIcon>
                                </div>
                            </th>
                            <th pSortableColumn="fechaVenta">
                                <div class="p-d-flex p-ai-center">
                                    <i class="pi pi-calendar p-mr-2"></i>
                                    Mes/Año
                                    <p-sortIcon field="fechaVenta"></p-sortIcon>
                                </div>
                            </th>
                        </tr>
                    </ng-template>
                    
                    <ng-template pTemplate="body" let-ventas>
                        <tr>
                            <td><span class="price-badge">{{ventas.totalVentas | number}}</span></td>
                            <td><span class="quantity-badge">{{ventas.cantidad | number}}</span></td>
                            <td>{{ventas.fechaVenta}}</td>
                        </tr>
                    </ng-template>
                    
                    <ng-template pTemplate="summary">
                        <div class="p-d-flex p-ai-center p-jc-between">
                            <span><i class="pi pi-database p-mr-2"></i>Total: {{listaProductosVentaMes?.length || 0}} registros</span>
                        </div>
                    </ng-template>
                </p-table>
            </div>
        </div>
    </div>
    <!-- Gráfica de Historia de Ingreso -->
    <div *ngIf="cargaInicial && nIdProductoConsulta" class="p-col-12 p-lg-6">
        <div class="card chart-card">
            <div class="card-header">
                <i class="pi pi-arrow-circle-down"></i>
                <h4>Ingresos del Producto</h4>
            </div>

            <div class="chart-container">
                <p-chart type="line" [data]="ingresoProductoGraf" [options]="lineOptions"></p-chart>
            </div>
               <p-table #dt3 [value]="listaIngresoProducto" [rows]="5" [paginator]="true"
                    [globalFilterFields]="['sFolioFactura','sRazonSocial','sUbicacion','nCantidad', 'dFechaIngreso', 'sNombreUsuario']" 
                    [rowHover]="true" dataKey="id" styleClass="p-datatable-sm p-datatable-striped"
                    currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} registros" 
                    [showCurrentPageReport]="true" responsiveLayout="scroll">
                    
                    <ng-template pTemplate="caption">
                        <div class="p-d-flex p-ai-center p-jc-between">
                            <span class="p-input-icon-left">
                                <i class="pi pi-search"></i>
                                <input pInputText type="text" (input)="dt3.filterGlobal($event.target.value, 'contains')"
                                    placeholder="Buscar..." class="p-inputtext-sm" />
                            </span>
                        </div>
                    </ng-template>
                    
                    <ng-template pTemplate="header">
                        <tr>
                            <th pSortableColumn="sFolioFactura">
                                <div class="p-d-flex p-ai-center">
                                    <i class="pi pi-file p-mr-2"></i>
                                    Folio/Pedido
                                    <p-sortIcon field="sFolioFactura"></p-sortIcon>
                                </div>
                            </th>
                            <th pSortableColumn="sRazonSocial">
                                <div class="p-d-flex p-ai-center">
                                    <i class="pi pi-building p-mr-2"></i>
                                    Proveedor
                                    <p-sortIcon field="sRazonSocial"></p-sortIcon>
                                </div>
                            </th>
                            <th pSortableColumn="sUbicacion">
                                <div class="p-d-flex p-ai-center">
                                    <i class="pi pi-map-marker p-mr-2"></i>
                                    Ubicación
                                    <p-sortIcon field="sUbicacion"></p-sortIcon>
                                </div>
                            </th>
                            <th pSortableColumn="nCantidad">
                                <div class="p-d-flex p-ai-center">
                                    <i class="pi pi-box p-mr-2"></i>
                                    Cantidad
                                    <p-sortIcon field="nCantidad"></p-sortIcon>
                                </div>
                            </th>
                            <th pSortableColumn="sNombreUsuario">
                                <div class="p-d-flex p-ai-center">
                                    <i class="pi pi-user p-mr-2"></i>
                                    Usuario
                                    <p-sortIcon field="sNombreUsuario"></p-sortIcon>
                                </div>
                            </th>
                            <th pSortableColumn="dFechaIngreso">
                                <div class="p-d-flex p-ai-center">
                                    <i class="pi pi-calendar p-mr-2"></i>
                                    Fecha
                                    <p-sortIcon field="dFechaIngreso"></p-sortIcon>
                                </div>
                            </th>
                        </tr>
                    </ng-template>
                    
                    <ng-template pTemplate="body" let-producto>
                        <tr>
                            <td><span class="folio-badge">{{producto.sFolioFactura}}</span></td>
                            <td>{{producto.sRazonSocial}}</td>
                            <td><span class="location-badge">{{producto.sUbicacion}}</span></td>
                            <td><span class="quantity-badge">{{producto.nCantidad}}</span></td>
                            <td>{{producto.sNombreUsuario}}</td>
                            <td>{{producto.dFechaIngreso | date:'dd/MM/yyyy'}}</td>
                        </tr>
                    </ng-template>
                    
                    <ng-template pTemplate="summary">
                        <div class="p-d-flex p-ai-center p-jc-between">
                            <span><i class="pi pi-database p-mr-2"></i>Total: {{listaIngresoProducto?.length || 0}} registros</span>
                        </div>
                    </ng-template>
                </p-table>
        </div>
    </div>

    <!-- Tabla de Historia de Ingreso -->
  

    <!-- Historial de Ventas -->
    <div *ngIf="cargaInicial" class="p-col-12 p-lg-6">
        <div class="card chart-card">
            <div class="card-header">
                <i class="pi pi-list"></i>
                <h4>Historial de Ventas del Producto</h4>
            </div>

            <div class="chart-container">
                <p-chart type="line" [data]="ventasProductoGraf" [options]="lineOptions"></p-chart>
            </div>

            <div class="p-mt-4">
                <p-table #dt2 [value]="listaVentasProducto" [rows]="5" [paginator]="true"
                    [globalFilterFields]="['nIdVenta','nCantidad', 'twVenta.tcCliente.sRazonSocial','twVenta.dFechaVenta']" 
                    [rowHover]="true" dataKey="id" styleClass="p-datatable-sm p-datatable-striped"
                    currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} registros" 
                    [showCurrentPageReport]="true" responsiveLayout="scroll">
                
                <ng-template pTemplate="caption">
                    <div class="p-d-flex p-ai-center p-jc-between">
                        <span class="p-input-icon-left">
                            <i class="pi pi-search"></i>
                            <input pInputText type="text" (input)="dt2.filterGlobal($event.target.value, 'contains')"
                                placeholder="Buscar..." class="p-inputtext-sm" />
                        </span>
                    </div>
                </ng-template>
                
                <ng-template pTemplate="header">
                    <tr>
                        <th pSortableColumn="nIdVenta">
                            <div class="p-d-flex p-ai-center">
                                <i class="pi pi-hashtag p-mr-2"></i>
                                No. Venta
                                <p-sortIcon field="nIdVenta"></p-sortIcon>
                            </div>
                        </th>
                        <th pSortableColumn="nCantidad">
                            <div class="p-d-flex p-ai-center">
                                <i class="pi pi-shopping-cart p-mr-2"></i>
                                Cantidad
                                <p-sortIcon field="nCantidad"></p-sortIcon>
                            </div>
                        </th>
                        <th pSortableColumn="twVenta.tcCliente.sRazonSocial">
                            <div class="p-d-flex p-ai-center">
                                <i class="pi pi-user p-mr-2"></i>
                                Cliente
                                <p-sortIcon field="twVenta.tcCliente.sRazonSocial"></p-sortIcon>
                            </div>
                        </th>
                        <th pSortableColumn="twVenta.dFechaVenta">
                            <div class="p-d-flex p-ai-center">
                                <i class="pi pi-calendar p-mr-2"></i>
                                Fecha
                                <p-sortIcon field="twVenta.dFechaVenta"></p-sortIcon>
                            </div>
                        </th>
                    </tr>
                </ng-template>
                
                <ng-template pTemplate="body" let-ventas>
                    <tr>
                        <td><span class="id-badge">{{ventas.nIdVenta}}</span></td>
                        <td><span class="quantity-badge">{{ventas.nCantidad}}</span></td>
                        <td>{{ventas.twVenta.tcCliente.sRazonSocial}}</td>
                        <td>{{ventas.twVenta.dFechaVenta | date:'dd/MM/yyyy'}}</td>
                    </tr>
                </ng-template>
                
                <ng-template pTemplate="summary">
                    <div class="p-d-flex p-ai-center p-jc-between">
                        <span><i class="pi pi-database p-mr-2"></i>Total: {{listaVentasProducto?.length || 0}} registros</span>
                    </div>
                </ng-template>
            </p-table>
            </div>
         
        </div>
    </div>

    <!-- Historial de Stock -->
    <div *ngIf="cargaInicial && nIdProductoConsulta" class="p-col-12 p-lg-6">
        <div class="card table-card">
            <div class="card-header">
                <i class="pi pi-chart-bar"></i>
                <h4>Historial de Stock</h4>
            </div>
            <app-historial-stock-producto [nIProducto]="nIdProductoConsulta"></app-historial-stock-producto>
             <div style="margin-top: 50px;">
                <div class="card-header" style="background: #FCDADA;">
                <i class="pi pi-chart-bar"></i>
                <h4>Cancelaciones</h4>
            </div>
                
                
                <app-productos-cancelados [nIProducto]="nIdProductoConsulta"></app-productos-cancelados></div>
        </div>
    </div>

    <!-- Historial de Inventarios por Ubicación -->
    <div *ngIf="cargaInicial && listaInventariosProducto.length > 0" class="p-col-12">
        <div class="card table-card">
            <div class="card-header" style="background: linear-gradient(135deg, #8b5cf6, #6d28d9);">
                <i class="pi pi-clipboard"></i>
                <h4 style="color: white;">Inventarios por Ubicación ({{listaInventariosProducto.length}})</h4>
            </div>
            <div class="p-mt-3">
                <p-table [value]="listaInventariosProducto" [rows]="5" [paginator]="true"
                    [globalFilterFields]="['sBodega','sAnaquel','sNivel','sNombreUsuarioResponsable','sDescripcionEstatus']" 
                    [rowHover]="true" dataKey="nId" styleClass="p-datatable-sm p-datatable-striped"
                    currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} registros" 
                    [showCurrentPageReport]="true" responsiveLayout="scroll">
                    
                    <ng-template pTemplate="caption">
                        <div class="p-d-flex p-ai-center p-jc-between">
                            <span class="p-text-secondary">
                                <i class="pi pi-info-circle p-mr-1"></i>
                                Inventarios donde aparece este producto
                            </span>
                        </div>
                    </ng-template>
                    
                    <ng-template pTemplate="header">
                        <tr>
                            <th pSortableColumn="nId" style="width: 70px;">
                                <div class="p-d-flex p-ai-center">
                                    ID
                                    <p-sortIcon field="nId"></p-sortIcon>
                                </div>
                            </th>
                            <th>Ubicación</th>
                            <th pSortableColumn="sNombreUsuarioResponsable">
                                <div class="p-d-flex p-ai-center">
                                    Responsable
                                    <p-sortIcon field="sNombreUsuarioResponsable"></p-sortIcon>
                                </div>
                            </th>
                            <th pSortableColumn="dInicio">
                                <div class="p-d-flex p-ai-center">
                                    <i class="pi pi-calendar p-mr-2"></i>
                                    Fecha
                                    <p-sortIcon field="dInicio"></p-sortIcon>
                                </div>
                            </th>
                            <th style="text-align: center;">Estatus</th>
                            <th style="text-align: center;">Cant. Inicial</th>
                            <th style="text-align: center;">Cant. Contada</th>
                            <th style="text-align: center;">Diferencia</th>
                            <th style="text-align: center;">Ajustado</th>
                        </tr>
                    </ng-template>
                    
                    <ng-template pTemplate="body" let-inv>
                        <tr>
                            <td><span class="p-text-bold" style="color: #8b5cf6;">#{{inv.nId}}</span></td>
                            <td>
                                <div class="p-text-bold" style="font-size: 0.9rem;">{{inv.sBodega}}</div>
                                <div class="p-text-secondary" style="font-size: 0.8rem;">{{inv.sAnaquel}} - {{inv.sNivel}}</div>
                            </td>
                            <td>{{inv.sNombreUsuarioResponsable || 'N/A'}}</td>
                            <td>{{inv.dInicio | date:'dd/MM/yyyy'}}</td>
                            <td style="text-align: center;">
                                <p-tag [value]="inv.sDescripcionEstatus" 
                                    [severity]="inv.nEstatus === 5 ? 'success' : inv.nEstatus === 6 ? 'danger' : inv.nEstatus === 3 ? 'info' : inv.nEstatus === 2 ? 'warning' : 'success'"
                                    [style]="{'font-size': '0.75rem'}">
                                </p-tag>
                            </td>
                            <td style="text-align: center;">
                                <span class="p-text-bold" style="color: #64748b;">
                                    {{inv.detalle && inv.detalle[0] ? inv.detalle[0].nCantidadTeoricaIni : '-'}}
                                </span>
                            </td>
                            <td style="text-align: center;">
                                <span *ngIf="inv.detalle && inv.detalle[0]?.nCantidadContada != null" class="p-text-bold" style="color: #6366f1;">
                                    {{inv.detalle[0].nCantidadContada}}
                                </span>
                                <span *ngIf="!(inv.detalle && inv.detalle[0]?.nCantidadContada != null)" class="p-text-secondary">-</span>
                            </td>
                            <td style="text-align: center;">
                                <ng-container *ngIf="inv.detalle && inv.detalle[0]?.nCantidadContada != null && inv.detalle[0]?.nDiferencia !== 0">
                                    <span class="p-text-bold" [style.color]="inv.detalle[0].nDiferencia < 0 ? '#ef4444' : '#22c55e'">
                                        {{inv.detalle[0].nDiferencia > 0 ? '+' : ''}}{{inv.detalle[0].nDiferencia}}
                                    </span>
                                </ng-container>
                                <span *ngIf="inv.detalle && inv.detalle[0]?.nCantidadContada != null && inv.detalle[0]?.nDiferencia === 0" 
                                      class="p-text-bold" style="color: #22c55e;">0</span>
                                <span *ngIf="!(inv.detalle && inv.detalle[0]?.nCantidadContada != null)" class="p-text-secondary">-</span>
                            </td>
                            <td style="text-align: center;">
                                <i *ngIf="inv.detalle && inv.detalle[0]?.bAjustado" class="pi pi-check-circle" style="color: #22c55e;"></i>
                                <span *ngIf="!(inv.detalle && inv.detalle[0]?.bAjustado)" class="p-text-secondary">-</span>
                            </td>
                        </tr>
                    </ng-template>
                    
                    <ng-template pTemplate="summary">
                        <div class="p-d-flex p-ai-center p-jc-between">
                            <span><i class="pi pi-database p-mr-2"></i>Total: {{listaInventariosProducto.length}} inventarios</span>
                        </div>
                    </ng-template>
                </p-table>
            </div>
        </div>
    </div>

  
   


  
</div>